<!doctype html><html lang=en-us class=dark><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Network Namespaces and Veth pairs | s9a.me</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Containers are a thing now and microservices the new buzz word. But how do containers work? How are containers magically separated from each other?
VMs require an entire operating system running and therefore consumes memory and CPU. In fact, if I remember correctly, running a Ubuntu VM requires atleast 500-600mb of memory and at least one CPU core. But containers run in fraction of resources and provide almost similar features for an application developer."><meta name=generator content="Hugo 0.109.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/css/syntax.css><link rel=stylesheet href=/css/style.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&family=Source+Sans+Pro:wght@200;300;400;700;900&display=swap"><meta property="og:title" content="Network Namespaces and Veth pairs"><meta property="og:description" content="Containers are a thing now and microservices the new buzz word. But how do containers work? How are containers magically separated from each other?
VMs require an entire operating system running and therefore consumes memory and CPU. In fact, if I remember correctly, running a Ubuntu VM requires atleast 500-600mb of memory and at least one CPU core. But containers run in fraction of resources and provide almost similar features for an application developer."><meta property="og:type" content="article"><meta property="og:url" content="/posts/2022-12-14-network-namespaces-and-veth/"><meta property="og:image" content="/images/slipbox.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-14T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-14T00:00:00+00:00"><meta property="og:site_name" content="sureshsarda.me"><meta itemprop=name content="Network Namespaces and Veth pairs"><meta itemprop=description content="Containers are a thing now and microservices the new buzz word. But how do containers work? How are containers magically separated from each other?
VMs require an entire operating system running and therefore consumes memory and CPU. In fact, if I remember correctly, running a Ubuntu VM requires atleast 500-600mb of memory and at least one CPU core. But containers run in fraction of resources and provide almost similar features for an application developer."><meta itemprop=datePublished content="2022-12-14T00:00:00+00:00"><meta itemprop=dateModified content="2022-12-14T00:00:00+00:00"><meta itemprop=wordCount content="783"><meta itemprop=image content="/images/slipbox.jpg"><meta itemprop=keywords content="containers,linux kernel,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/slipbox.jpg"><meta name=twitter:title content="Network Namespaces and Veth pairs"><meta name=twitter:description content="Containers are a thing now and microservices the new buzz word. But how do containers work? How are containers magically separated from each other?
VMs require an entire operating system running and therefore consumes memory and CPU. In fact, if I remember correctly, running a Ubuntu VM requires atleast 500-600mb of memory and at least one CPU core. But containers run in fraction of resources and provide almost similar features for an application developer."></head><body class="bg-slate-100 dark:bg-slate-900"><main><article class="center bg-white relative max-w-4xl mx-auto px-12 py-16"><header class="border-b-2 mb-8"><aside><a href=/ class="font-semibold text-base uppercase text-sky-700">HOME</a></aside><h1 class="text-5xl my-4">Network Namespaces and Veth pairs</h1><div class=mb-12><time class="text-base text-gray-700" datetime=2022-12-14T00:00:00Z>December 14, 2022</time></div></header><div class=prose><p>Containers are a thing now and microservices the new buzz word. But how do containers work? How are containers magically
separated from each other?</p><p>VMs require an entire operating system running and therefore consumes memory and CPU. In fact, if I remember correctly,
running a Ubuntu VM requires atleast 500-600mb of memory and at least one CPU core. But containers run in fraction of
resources and provide almost similar features for an application developer. How?</p><p>In this post, I&rsquo;ll talk about creating a new namespace and connecting it from the host machine.</p><p>Let us begin by creating a new namepsace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; ip netns add blue
</span></span></code></pre></div><p>After this, we need to connect this namespace to the host machine. For that we
will use a veth pair. A veth pair is like an ethernet cable with two ends. Whatever
you send from the one end comes out from the other end.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># create a link calld veth0 of type veth and name the peer (or other end) as veth1</span>
</span></span><span style=display:flex><span>&gt; ip link add veth0 type veth peer name veth1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># verify if it has been created correctly</span>
</span></span><span style=display:flex><span>&gt; ip link show type veth
</span></span><span style=display:flex><span>9: veth1@veth0: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu <span style=color:#ae81ff>1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether 4a:b7:5f:be:4d:bb brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>10: veth0@veth1: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu <span style=color:#ae81ff>1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether 36:ad:98:c3:06:b7 brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></div><p>The above snippet creates a veth pair with two veth ends - veth0 and veth1.
These are currently assigned to the host VM. Next we need to connect one of the
ends to the new namespaces. We will do this next:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># connect one end in the blue namespace</span>
</span></span><span style=display:flex><span>&gt; ip link set veth1 netns blue
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># since the other end is connect to the namespace it is hidden here</span>
</span></span><span style=display:flex><span>&gt; ip link show type veth
</span></span><span style=display:flex><span>10: veth0@if9: &lt;BROADCAST,MULTICAST&gt; mtu <span style=color:#ae81ff>1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether 36:ad:98:c3:06:b7 brd ff:ff:ff:ff:ff:ff link-netns blue
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># but can be seen in the blue namespace</span>
</span></span><span style=display:flex><span>&gt; ip netns exec blue ip link show
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noop state DOWN mode DEFAULT group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>9: veth1@if10: &lt;BROADCAST,MULTICAST&gt; mtu <span style=color:#ae81ff>1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether 4a:b7:5f:be:4d:bb brd ff:ff:ff:ff:ff:ff link-netnsid <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Let&rsquo;s assign IP addresses and start the devices so that we can send data</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ip address to the host end</span>
</span></span><span style=display:flex><span>&gt; ip addr add 10.0.0.10/24 dev veth0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ip address to the blue end</span>
</span></span><span style=display:flex><span>&gt; ip netns exec blue ip addr add 10.0.0.1/24 dev veth1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># enable the devices</span>
</span></span><span style=display:flex><span>&gt; ip link set veth0 up
</span></span><span style=display:flex><span>&gt; ip netns exec blue ip link set veth1 up
</span></span><span style=display:flex><span>&gt; ip netns exec blue ip link set lo up
</span></span></code></pre></div><p>(Note, if we want to execute a command inside a name space we use <code>ip netns exec &lt;namespace> &lt;command></code>)</p><p>Let&rsquo;s see if these devices are connected:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; ping -c1 10.0.0.1
</span></span><span style=display:flex><span>PING 10.0.0.1 <span style=color:#f92672>(</span>10.0.0.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 10.0.0.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>0</span> received, 100% packet loss, time 0ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; ip netns exec blue ping -c1 10.0.0.10
</span></span><span style=display:flex><span>PING 10.0.0.10 <span style=color:#f92672>(</span>10.0.0.10<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 10.0.0.10 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>0</span> received, 100% packet loss, time 0ms
</span></span></code></pre></div><p>Looks like No. Because although one end is connected to our host VM, it still
doesn&rsquo;t know which traffic should be routed or which network exists on the other
end of the veth. So the host does&rsquo;t send any traffic. The network is unavailable
in other words. Similarly for the endpoint in the blue namespace.</p><p>Let&rsquo;s correct this by adding a routes</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># tell blue namespace that any traffic to 10.0.0.10 should go via device veth1</span>
</span></span><span style=display:flex><span>&gt; ip netns exec blue ip route add 10.0.0.10 dev veth1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># tell the host that any traffic to 10.0.0.1 should go via veth0</span>
</span></span><span style=display:flex><span>&gt; ip route add 10.0.0.1 dev veth0
</span></span></code></pre></div><p>After this, the pings are successful:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; ping -c1 10.0.0.1
</span></span><span style=display:flex><span>PING 10.0.0.1 <span style=color:#f92672>(</span>10.0.0.1<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.1: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.021 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 10.0.0.1 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.021/0.021/0.021/0.000 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; ip netns exec blue ping -c1 10.0.0.10
</span></span><span style=display:flex><span>PING 10.0.0.10 <span style=color:#f92672>(</span>10.0.0.10<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.0.0.10: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.021 ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>--- 10.0.0.10 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> packets transmitted, <span style=color:#ae81ff>1</span> received, 0% packet loss, time 0ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.021/0.021/0.021/0.000 ms
</span></span></code></pre></div><p>This is a very simple example of how networking is taken care of when containers
are deployed. An easy enhancement can be done using bridges. Veths are connected to a bridge and routing is taken care by the bridge. But the concepts of namespaces
remain the same.</p></div><a class="text-sky-600 mr-2" href=/tags/containers>#containers</a>
<a class="text-sky-600 mr-2" href=/tags/linux-kernel>#linux kernel</a><div id=sharing class="mt3 ananke-socials"><a href="https://twitter.com/share?url=/posts/2022-12-14-network-namespaces-and-veth/&text=Network%20Namespaces%20and%20Veth%20pairs" class="ananke-social-link twitter no-underline" aria-label="share on Twitter"></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=/posts/2022-12-14-network-namespaces-and-veth/&title=Network%20Namespaces%20and%20Veth%20pairs" class="ananke-social-link linkedin no-underline" aria-label="share on LinkedIn"></a></div><aside></aside><aside>Want to discuss this further? You can reach out to via
<a class=text-sky-500 href=https://twitter.com/sureshssarda>Twitter</a>,
<a class=text-sky-500 href=https://www.linkedin.com/in/sureshsarda/>LinkedIn</a> or directly via
<a class=text-sky-500 href="mailto:sureshssarda@gmail.com?subject=Network%20Namespaces%20and%20Veth%20pairs">Email.</a></aside></article></main><footer class="bg-black dark:bg-slate-900 text-white bottom-0 w-100 pa3" role=contentinfo><div class="center relative max-w-4xl mx-auto px-12 py-16"><section class=mb-4><h1 class="text-2xl uppercase hover:text-gray-500"><a href=/about>About</a></h1><p>Hi! I'm Suresh. Your host. You can get to know me better in the
<a class="link white dim" href=/about>about</a> section or follow me
using the social media icons on the right</p><div><div class=ananke-socials><a href=https://twitter.com/sureshssarda target=_blank class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window">Twitter</a>
<a href=https://github.com/sureshsarda target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window">GitHub</a>
<a href=https://www.linkedin.com/in/sureshsarda/ target=_blank class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window">LinkedIn</a>
<a href=https://sureshssarda.medium.com/ target=_blank class="medium ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Medium link" rel=noopener aria-label="follow on Medium——Opens in a new window">Medium</a></div></div></section><section class=mb-4><h1 class="text-2xl uppercase hover:text-gray-500"><a href=/categories>categories</a></h1><a class=hover:text-gray-400 href=/categories/linux>linux (6)</a></section><section class=mb-4><h1 class="text-2xl uppercase hover:text-gray-500"><a href=/tags>tags</a></h1><a class=hover:text-gray-400 href=/tags/ai>ai (1)</a>
<a class=hover:text-gray-400 href=/tags/apache-hadoop>apache-hadoop (1)</a>
<a class=hover:text-gray-400 href=/tags/apache-kafka>apache-kafka (1)</a>
<a class=hover:text-gray-400 href=/tags/apache-spark>apache-spark (1)</a>
<a class=hover:text-gray-400 href=/tags/apache-storm>apache-storm (1)</a>
<a class=hover:text-gray-400 href=/tags/big-data>big-data (1)</a>
<a class=hover:text-gray-400 href=/tags/clean-code>clean-code (3)</a>
<a class=hover:text-gray-400 href=/tags/containers>containers (1)</a>
<a class=hover:text-gray-400 href=/tags/data>data (1)</a>
<a class=hover:text-gray-400 href=/tags/design-patterns>design-patterns (2)</a>
<a class=hover:text-gray-400 href=/tags/docker>docker (2)</a>
<a class=hover:text-gray-400 href=/tags/elasticsearch>elasticsearch (5)</a>
<a class=hover:text-gray-400 href=/tags/java>java (11)</a>
<a class=hover:text-gray-400 href=/tags/linux>linux (11)</a>
<a class=hover:text-gray-400 href=/tags/linux-kernel>linux-kernel (1)</a>
<a class=hover:text-gray-400 href=/tags/notes>notes (1)</a>
<a class=hover:text-gray-400 href=/tags/performance>performance (1)</a>
<a class=hover:text-gray-400 href=/tags/power-unix-tools>power-unix-tools (1)</a>
<a class=hover:text-gray-400 href=/tags/programming>programming (2)</a>
<a class=hover:text-gray-400 href=/tags/python>python (3)</a>
<a class=hover:text-gray-400 href=/tags/reflection>reflection (1)</a>
<a class=hover:text-gray-400 href=/tags/research-paper>research-paper (2)</a>
<a class=hover:text-gray-400 href=/tags/sdlc>sdlc (1)</a>
<a class=hover:text-gray-400 href=/tags/spring>spring (2)</a>
<a class=hover:text-gray-400 href=/tags/unit-testing>unit-testing (1)</a></section><section class="mb-4 text-gray-400"><a href=/>&copy; Suresh Sarda 2022</a>
<span>Hosted on Github. Created using Tailwind CSS and Hugo.</span></section></div></div></footer></body></html>