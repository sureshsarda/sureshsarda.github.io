<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  
  <title>Elasticsearch Bulk API Example and Performance Comparison</title>
  <meta property="og:title" content="Elasticsearch Bulk API Example and Performance Comparison" />
  <meta name="twitter:title" content="Elasticsearch Bulk API Example and Performance Comparison" />
  

  

  <meta name="author" content=""/>
  <meta property="og:site_name" content="Programming Notes" />
  <meta property="og:url" content="https://sureshsarda.github.io/posts/elasticsearch/2017-04-14-elasticsearch-bulk-api-example-and-performance-comparison/" />

  
  <meta name="twitter:card" content="summary" />

  

  
  <meta property="og:type" content="article" />
  
  
  
  <meta name="generator" content="Hugo 0.80.0" />
  
  

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@100;300;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Oxygen&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">


  <link rel="stylesheet" href="https://sureshsarda.github.io/assets/css/style.css" />
  <link rel="stylesheet" href="https://sureshsarda.github.io/assets/css/custom.css" />
  
  
  
  <script type="text/javascript" src="https://sureshsarda.github.io/assets/js/bundle.js"></script>
</head>




<body>
    <article class="container">
        <header>
            

            
                <p>
                    <a href="/">Programming Notes</a>
                </p>
                <h1>Elasticsearch Bulk API Example and Performance Comparison</h1>
                
                <a href="https://sureshsarda.github.io/tags/bulk-api" class="c-tag">bulk-api</a>
                
                <a href="https://sureshsarda.github.io/tags/performance" class="c-tag">performance</a>
                
            
            
        </header>





        <main id="js-article" class="container">
            <div class="row">

                <div class="col-9 py-5">
                    <p>Elasticsearch provides bulk operations to perform multiple operations in a single call. Bulk APIs can be accessed by hitting the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html">_bulk</a> endpoint.
This post demonstrates the use of bulk API with Python. It assumes that you are familiar (not expert) with <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html">REST Bulk API of Elasticsearch</a>. To keep it simple we will just consider the insertion case.</p>
<h2 id="problem-statement">Problem Statement</h2>
<p>Before we jump into code, let’s take a minute and think about the problem in hand. We have some data that we want to insert into Elasticsearch.</p>
<p>To simulate this, we need a data generation module that provides us data. At times, we cannot directly insert the data in the database. We need to perform some sort of processing on the data before inserting it. After this, we can send these documents to Elasticsearch. Summarizing this, we have 3 steps (or phases):</p>
<ol>
<li>Data generation</li>
<li>Processing of data</li>
<li>Insertion</li>
</ol>
<h2 id="elasticsearch-py"><a href="http://elasticsearch-py.readthedocs.io/en/master/index.html">elasticsearch-py</a></h2>
<p>We are going to use elasticsearch-py. Bulk APIs are provided as <a href="http://elasticsearch-py.readthedocs.io/en/master/helpers.html">helper method in elasticsearch-py</a>. Let’s now write code for each step.</p>
<h3 id="1-data-generation">1. Data Generation</h3>
<p>Data can be generated anyhow. It could be read from a file or from any other database or from a socket. It doesn’t matter. For this example, I’ll generate some random data.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_doc</span>(count<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Creates a document with random username, random salary amount, random profession and a date of birth
</span><span style="color:#e6db74">    :param count: number of documents to return
</span><span style="color:#e6db74">    :return: generator object for user documents
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_username</span>():
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(random<span style="color:#f92672">.</span>choice(string<span style="color:#f92672">.</span>ascii_lowercase) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>))
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_profession</span>():
        <span style="color:#66d9ef">return</span> random<span style="color:#f92672">.</span>choice([<span style="color:#e6db74">&#39;Accountant&#39;</span>, <span style="color:#e6db74">&#39;Doctor&#39;</span>, <span style="color:#e6db74">&#39;Engineer&#39;</span>, <span style="color:#e6db74">&#39;Realtor&#39;</span>, <span style="color:#e6db74">&#39;Writer&#39;</span>])
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_user_doc</span>():
        <span style="color:#66d9ef">return</span> dict(
            username<span style="color:#f92672">=</span>generate_username(),
            profession<span style="color:#f92672">=</span>generate_profession(),
            salary<span style="color:#f92672">=</span>random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">100000</span>)
        )

    random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">33</span>)
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(count):
        <span style="color:#66d9ef">yield</span> generate_user_doc()
</code></pre></div><h3 id="data-processing">Data Processing</h3>
<p>Okay, so we have our data. Now we need to process this. This step is required if you are copying the data from some other database to ES and need to perform some preprocessing. But since we have the data in the correct format, we will just skip this step.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_document</span>(document):
    <span style="color:#75715e"># Add document processing here</span>
    <span style="color:#66d9ef">return</span> document
</code></pre></div><p>You could add your implementation in this method.</p>
<h3 id="bulk-insertion">Bulk Insertion</h3>
<p>Alright, now we have all the data we need. Let’s store it. But before we store there’s something that we need to consider. The body of bulk API should contain the some metadata. It should contain the <code>operation</code> we need to perform, what <code>index</code> and what <code>type</code> to perform on, etc. For every document we need this metadata. Let’s write one more method that adds this information.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_bulk_api_query</span>(document_generator, index, type, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;index&#39;</span>):
    <span style="color:#66d9ef">for</span> doc <span style="color:#f92672">in</span> document_generator:
        d <span style="color:#f92672">=</span> dict(
            _op_type<span style="color:#f92672">=</span>action,
            _index<span style="color:#f92672">=</span>index,
            _type<span style="color:#f92672">=</span>type,
            _source<span style="color:#f92672">=</span>doc
        )
        <span style="color:#66d9ef">yield</span> d
</code></pre></div><p>This function takes the generator object we created earlier and returns it’s own generator object that adds some metadata to the document. Simple.</p>
<p>Next we perform the operation we specified earlier. And this is as simple as executing this one statement:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">success, failed <span style="color:#f92672">=</span> bulk(client, create_bulk_api_query(documents, index<span style="color:#f92672">=</span>index, type<span style="color:#f92672">=</span>type))
</code></pre></div><p>We have passed an Elasticsearch <code>client</code>, the <code>generator</code> object and the <code>index</code> and <code>type</code> to perform the operations on. It returns a tuple with 2 fields – <code>success</code> count and <code>failure</code> count. That&rsquo;s it!
The complete script can be found <a href="https://github.com/sureshsarda/scripts/blob/master/bulk_api.py">here</a>.</p>
<h2 id="comparing-performance-with-regular-inserts">Comparing Performance with regular inserts:</h2>
<p>So I tried to insert some documents with bulk API. It looked fast to me. It had to be. But the results I found were astonishing:</p>
<table>
<thead>
<tr>
<th style="text-align:right">Documents</th>
<th style="text-align:right">One by One</th>
<th style="text-align:right">Bulk</th>
<th style="text-align:right">Gain</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">100</td>
<td style="text-align:right">1.3989231586</td>
<td style="text-align:right">0.1614105701</td>
<td style="text-align:right">8.6668621354</td>
</tr>
<tr>
<td style="text-align:right">1000</td>
<td style="text-align:right">10.0419487953</td>
<td style="text-align:right">0.3521802425</td>
<td style="text-align:right">28.5136631258</td>
</tr>
<tr>
<td style="text-align:right">10000</td>
<td style="text-align:right">64.6501646042</td>
<td style="text-align:right">2.8116579056</td>
<td style="text-align:right">22.9936097403</td>
</tr>
<tr>
<td style="text-align:right">100000</td>
<td style="text-align:right">600.7230203152</td>
<td style="text-align:right">17.1942903996</td>
<td style="text-align:right">34.9373545727</td>
</tr>
</tbody>
</table>
<h4 id="plotting-it">Plotting it:</h4>
<p><img src="/assets/images/posts/es/performance.png" alt="Comparasion"></p>
<p>I was expecting a 5x or 10x gain. 34X at 100k documents is a lot!</p>
<p><em>Note: This is not a benchmarking study. These are just approximate results and should be used only as guideline.</em></p>


                </div>
                <aside class="bd-toc toc col-2 py-5">
                    <div class="sticky-top pt-5">
                        <h3>On this page</h3>
                        <nav id="TableOfContents">
  <ul>
    <li><a href="#problem-statement">Problem Statement</a></li>
    <li><a href="#elasticsearch-py"><a href="http://elasticsearch-py.readthedocs.io/en/master/index.html">elasticsearch-py</a></a>
      <ul>
        <li><a href="#1-data-generation">1. Data Generation</a></li>
        <li><a href="#data-processing">Data Processing</a></li>
        <li><a href="#bulk-insertion">Bulk Insertion</a></li>
      </ul>
    </li>
    <li><a href="#comparing-performance-with-regular-inserts">Comparing Performance with regular inserts:</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
                    </div>
                </aside>
            </div>

            


        </main>

        
    </article>
    <footer class="mt-5 py-5">
    <div class="container py-5">
        
        <div class="row">
            <div class="col-lg-4 mb-3">
                <h3>
                    <a href="/">Programming Notes</a>
                </h3>
                <ul class="list-unstyled">
                    <li>Share the knowledge that you can and learn more in the process.</li>
                </ul>

            </div>
            <div class="col-lg-1"></div>
            
            
            <div class="col-lg-2">
                <h5>Curated</h5>
                <ul class="list-unstyled">
                    
                    <li class="mb-2"><a href="/blog">Blog</a></li>
                    
                    <li class="mb-2"><a href="/books">Books</a></li>
                    
                    <li class="mb-2"><a href="/papers">Papers</a></li>
                    
                </ul>
            </div>
            
            
            
            <div class="col-lg-2">
                <h5>Links</h5>
                <ul class="list-unstyled">
                    
                    <li class="mb-2"><a href="/series">Article Series</a></li>
                    
                    <li class="mb-2"><a href="/categories">Categories</a></li>
                    
                    <li class="mb-2"><a href="/posts">Posts</a></li>
                    
                    <li class="mb-2"><a href="/tags">Tags</a></li>
                    
                </ul>
            </div>
            
            
            
            <div class="col-lg-2">
                <h5>Social</h5>
                <ul class="list-unstyled">
                    
                    <li class="mb-2"><a href="/">Github</a></li>
                    
                    <li class="mb-2"><a href="/">LinkedIn</a></li>
                    
                    <li class="mb-2"><a href="/">Medium</a></li>
                    
                    <li class="mb-2"><a href="/">Stack Overflow</a></li>
                    
                    <li class="mb-2"><a href="/">Twitter</a></li>
                    
                </ul>
            </div>
            
            
        </div>
        
    </div>

    <div class="p-copyright">
        
        Suresh Sarda
        &nbsp;&bull;&nbsp;
        2020

        
        &nbsp;&bull;&nbsp;
        <a href="https://sureshsarda.github.io/">Programming Notes</a>
        
        
    </div>
</footer>